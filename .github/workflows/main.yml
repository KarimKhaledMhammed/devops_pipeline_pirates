name: Build, Push, and Sign Backend

on:
  push:
    branches: [ "main" ]
    paths:
      - 'app/**'          # Only run if backend code changes
      - 'Dockerfile'      # Or if the Dockerfile changes
      - '.github/workflows/**'

env:
  # Image Name
  IMAGE_NAME: karimkhaled02/pipeline-pirates
  # We use the GitHub Run ID (e.g., 15, 16) as the version tag automatically!
  TAG: backend-v${{ github.run_number }}

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write # Needed for Cosign identity (optional but good practice)

    steps:
      # 1. Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Install Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.3.0

      # 4. Build and Push the Image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.TAG }}

      # 5. Sign the Image
      - name: Sign the Image
        run: |
          cosign sign --yes --key env://COSIGN_PRIVATE_KEY "${{ env.IMAGE_NAME }}:${{ env.TAG }}"
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          # "tlog-upload: false" avoids uploading to the public transparency log 
          # if you want to keep it private, otherwise remove this flag or keep defaults.
          
      - name: Summary
        run: echo "Successfully pushed and signed ${{ env.IMAGE_NAME }}:${{ env.TAG }}"
